<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BGM Player</title>
</head>
<body>
  <audio id="bgm" loop autoplay></audio>
  <script>
    const audio = document.getElementById("bgm");

    // 初回読み込み処理
    const bgmFile = sessionStorage.getItem("lastBgm");
    const bgmTime = parseFloat(sessionStorage.getItem("bgmTime") || "0");

    console.log("📦 Initial lastBgm:", bgmFile);
    console.log("📦 Initial bgmTime:", bgmTime);

    if (bgmFile && bgmFile !== "null" && bgmFile !== "") {
      audio.src = "/kiwiSisters/music/" + bgmFile;
      audio.currentTime = !isNaN(bgmTime) ? bgmTime : 0;
      audio.play().catch((e) => console.warn("Autoplay error:", e));
    }

    console.log("👂 Waiting for messages...");

    // メッセージ受信処理
    window.addEventListener("message", (e) => {
      console.log("📩 Received message:", e.data);

      const { bgm, currentTime, type } = e.data || {};

      if (type === "requestCurrentTime") {
        if (!audio.paused) {
          e.source?.postMessage({ currentTime: audio.currentTime }, "*");
        }
        return;
      }

      if (bgm == null || bgm === "null" || bgm === "") {
        console.log("✅ Received null → Stopping BGM");
        audio.pause();
        audio.removeAttribute("src");
        audio.load();
        sessionStorage.removeItem("lastBgm");
        sessionStorage.removeItem("bgmTime");
        return;
      }

      if (typeof bgm !== "string" || !bgm) return;

      const time = typeof currentTime === "number" ? currentTime : 0;

      if (!audio.src.includes(bgm)) {
        audio.src = "/kiwiSisters/music/" + bgm;
      }

      audio.currentTime = time;
      audio.play().catch((e) => console.warn("Play error:", e));
      sessionStorage.setItem("lastBgm", bgm);
    });

    window.addEventListener("beforeunload", () => {
      if (!audio.paused) {
        sessionStorage.setItem("bgmTime", audio.currentTime);
      }
    });
  </script>
</body>
</html>
